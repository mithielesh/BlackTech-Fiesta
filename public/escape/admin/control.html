<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/global.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <title>Admin - Team Control</title>
    <style>
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 1200px;
            margin: 20px auto;
        }
        .team-card {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-left: 4px solid var(--primary-color);
            border-radius: 8px;
            margin-bottom: 12px;
        }
        .team-card strong {
            color: var(--primary-color);
        }
        .team-info {
            font-size: 13px;
            color: #a0aec0;
            margin: 8px 0;
            line-height: 1.6;
        }
        .team-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        .btn-advance {
            flex: 1;
            padding: 8px 12px;
            background: #1e3a8a;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .btn-advance:hover {
            background: #059669;
        }
        .btn-eliminate {
            flex: 1;
            padding: 8px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
        }
        .btn-eliminate:hover {
            background: #dc2626;
        }
        .status-active {
            color: #2563eb;
            font-weight: 600;
        }
        .status-eliminated {
            color: #ef4444;
            font-weight: 600;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px auto;
            max-width: 1200px;
        }
        .stat-card {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }
        .stat-label {
            font-size: 12px;
            color: #a0aec0;
            margin-top: 5px;
        }
        .controls-section {
            max-width: 1200px;
            margin: 20px auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        .refresh-btn {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }
        .refresh-btn:hover {
            opacity: 0.8;
        }
        
        /* Dropdown and input styling */
        select, input[type="text"], input[type="number"] {
            background: rgba(20, 20, 28, 0.75);
            color: #e5e7eb;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 8px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }
        
        select option {
            background: #0f0f16;
            color: #e5e7eb;
            padding: 12px;
        }
        
        select:focus, input:focus {
            outline: none;
            border: 1px solid rgba(37, 99, 235, 0.6);
        }
    </style>
</head>
<body>
    <header>
        <h1>üõ°Ô∏è Admin - Team Control Panel</h1>
    </header>
    <main>
        <div class="controls-section">
            <button class="refresh-btn" onclick="loadTeams()">üîÑ Refresh Teams</button>
            <div style="display: inline-block; float: right; font-size: 12px; color: #a0aec0;">
                Last updated: <span id="last-update">just now</span>
            </div>
        </div>

        <div class="controls-section">
            <h3 style="margin-top:0; color:var(--primary-color);">Level Definitions (Admin)</h3>
            <div style="display:flex; gap:8px; align-items:center;">
                <select id="def-level" style="padding:8px;">
                    <option value="1">Level 1</option>
                    <option value="2">Level 2</option>
                    <option value="3">Level 3</option>
                    <option value="4">Level 4</option>
                    <option value="5">Level 5</option>
                </select>
                <input id="def-prompt" placeholder="Prompt / Riddle (or items, clues)" style="flex:1; padding:8px;" />
                <input id="def-answer" placeholder="Exact answer (or comma-separated sequence)" style="width:220px; padding:8px;" />
                <input id="def-duration" placeholder="Duration (s)" type="number" style="width:120px; padding:8px;" />
                <input id="def-attempts" placeholder="Attempts (0=none)" type="number" style="width:120px; padding:8px;" />
                <button class="refresh-btn" onclick="saveDefinition()">Save</button>
            </div>
            <div style="margin-top:8px; font-size:12px; color:#a0aec0;">Definitions are proxied through the admin server (authenticate to access).</div>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div class="stat-label">Total Teams</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-active">0</div>
                <div class="stat-label">Active</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-waiting">0</div>
                <div class="stat-label">Waiting</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-eliminated">0</div>
                <div class="stat-label">Eliminated</div>
            </div>
        </div>

        <div style="max-width: 1200px; margin: 20px auto;">
            <h3 style="color: var(--primary-color); margin-bottom: 15px;">Active Teams (Not Eliminated)</h3>
            <div id="active-teams"></div>

            <h3 style="color: var(--primary-color); margin-top: 30px; margin-bottom: 15px;">Eliminated Teams</h3>
            <div id="eliminated-teams"></div>
        </div>
    </main>
    <footer>
        <p>&copy; 2026 IT Fiesta - Admin Panel</p>
    </footer>

    <script src="../assets/js/api.js"></script>
    <script>
        function formatTime() {
            var now = new Date();
            return now.toLocaleTimeString();
        }

        function loadTeams() {
            API.getAllTeams().then(function(teams) {
                if (!teams || teams.length === 0) {
                    document.getElementById('active-teams').innerHTML = '<p style="color: #a0aec0;">No teams yet.</p>';
                    document.getElementById('eliminated-teams').innerHTML = '<p style="color: #a0aec0;">No teams yet.</p>';
                    return;
                }

                // Separate active and eliminated
                var active = teams.filter(function(t) { return !t.eliminated; });
                var eliminated = teams.filter(function(t) { return t.eliminated; });

                // Sort by level and score
                active.sort(function(a, b) {
                    if (a.currentLevel !== b.currentLevel) return b.currentLevel - a.currentLevel;
                    return (b.level1_score || 0) - (a.level1_score || 0);
                });

                // Update stats
                document.getElementById('stat-total').textContent = teams.length;
                document.getElementById('stat-active').textContent = active.length;
                document.getElementById('stat-eliminated').textContent = eliminated.length;
                
                var waiting = active.filter(function(t) { return t.currentLevel <= 4; }).length;
                document.getElementById('stat-waiting').textContent = waiting;

                // Render active teams
                document.getElementById('active-teams').innerHTML = active.map(function(t) {
                    return `
                        <div class="team-card">
                            <strong>${t.teamName || t.teamId}</strong>
                            <div class="team-info">
                                <div>üìç Current Level: <strong>${t.currentLevel}</strong></div>
                                <div>üéØ Level 1: ${t.level1_score || 0} marks | L2: ${t.level2_score || 0} | L3: ${t.level3_score || 0} | L4: ${t.level4_score || 0}</div>
                                <div>TeamID: ${t.teamId}</div>
                            </div>
                            <div class="team-actions">
                                <button class="btn-advance" onclick="advanceTeam('${t.teamId}', '${t.teamName}')">‚û°Ô∏è Advance</button>
                                <button class="btn-eliminate" onclick="eliminateTeam('${t.teamId}', '${t.teamName}')">‚ùå Eliminate</button>
                            </div>
                        </div>
                    `;
                }).join('');

                // Render eliminated teams
                document.getElementById('eliminated-teams').innerHTML = eliminated.length > 0 
                    ? eliminated.map(function(t) {
                        return `
                            <div class="team-card" style="border-left-color: #ef4444; opacity: 0.6;">
                                <strong style="color: #ef4444;">${t.teamName || t.teamId}</strong>
                                <div class="team-info">
                                    <div>‚ùå <span class="status-eliminated">ELIMINATED</span></div>
                                    <div>Level: ${t.currentLevel} | Scores: L1: ${t.level1_score || 0} | L2: ${t.level2_score || 0}</div>
                                </div>
                            </div>
                        `;
                    }).join('')
                    : '<p style="color: #a0aec0;">No eliminated teams.</p>';

                document.getElementById('last-update').textContent = formatTime();
            }).catch(function(err) {
                console.error('Failed to load teams:', err);
                alert('Error loading teams. Check backend.');
            });
        }

        function saveDefinition() {
            var level = Number(document.getElementById('def-level').value);
            var prompt = document.getElementById('def-prompt').value;
            var answer = document.getElementById('def-answer').value;
            var duration = Number(document.getElementById('def-duration').value) || undefined;
            var attempts = Number(document.getElementById('def-attempts').value) || 0;
            if (!prompt || !answer) { alert('Please provide prompt and exact answer'); return; }
            API.adminDefineLevel(level, { prompt: prompt, correctAnswer: answer, durationSeconds: duration, attemptsAllowed: attempts }).then(function(res){
                if (res && res.success) {
                    alert('Definition saved for level ' + level);
                } else {
                    alert('Failed to save definition: ' + (res && res.error));
                }
            }).catch(function(err){ console.error(err); alert('Error saving definition'); });
        }

        function advanceTeam(teamId, teamName) {
            if (!confirm(`Advance ${teamName} to next level?`)) return;
            
            API.advanceTeam(teamId).then(function(res) {
                console.log('Team advanced:', res);
                alert('‚úì ' + teamName + ' advanced to level ' + res.team.currentLevel);
                loadTeams();
            }).catch(function(err) {
                console.error('Failed to advance:', err);
                alert('Error advancing team');
            });
        }

        function eliminateTeam(teamId, teamName) {
            if (!confirm(`ELIMINATE ${teamName}? This cannot be undone.`)) return;
            
            API.eliminateTeam(teamId).then(function(res) {
                console.log('Team eliminated:', res);
                alert('‚úì ' + teamName + ' has been eliminated');
                loadTeams();
            }).catch(function(err) {
                console.error('Failed to eliminate:', err);
                alert('Error eliminating team');
            });
        }

        // Auto-load teams on page load and refresh every 5 seconds
        loadTeams();
        setInterval(loadTeams, 5000);
    </script>
</body>
</html>
