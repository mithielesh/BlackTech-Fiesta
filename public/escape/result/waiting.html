<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../css/global.css">
    <link rel="stylesheet" href="../assets/css/style.css">
    <title>Waiting</title>
</head>
<body>
    <header>
        <h1>Waiting Page</h1>
    </header>
    <main>
        <section>
            <div id="waiting-root">
                <p>Please wait while we calculate the scores...</p>
                <div id="team-status" class="note" style="margin-top:12px"></div>

                <div style="margin-top:18px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                    <h3 style="margin:0">Current Rankings</h3>
                    <span class="muted" style="font-size:13px">Scores = level marks − penalties</span>
                </div>
                <div id="rankings" style="margin-top:8px"></div>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2026 IT Fiesta</p>
    </footer>

    <script src="../assets/js/api.js"></script>
    <script>
        (function(){
            var teamId = sessionStorage.getItem('teamId');
            if (!teamId) {
                document.getElementById('waiting-root').innerHTML = '<p class="muted">No team registered. Please go back and register.</p>';
                return;
            }

            var currentLevel = Number(sessionStorage.getItem('currentLevel') || 1);

            function goToNextLevel(nextLevel){
                window.location.href = '../levels/level' + nextLevel + '.html';
            }

            function renderRankings(teams){
                var el = document.getElementById('rankings');
                if (!teams || teams.length === 0) { el.innerHTML = '<p class="muted">No teams yet.</p>'; return; }

                // Normalize and sort by totalScore desc then time asc
                var normalized = teams.map(function(t){
                    var rawScore = Number(t.score || 0);
                    var penalty = Number(t.penalty || 0);
                    var totalScore = Math.max(0, rawScore - penalty);
                    return Object.assign({}, t, { totalScore: totalScore });
                }).sort(function(a, b){
                    if (b.totalScore !== a.totalScore) return b.totalScore - a.totalScore;
                    return (a.totalExamTime || 0) - (b.totalExamTime || 0);
                });

                el.innerHTML = normalized.slice(0, 20).map(function(t, idx){
                    var badge = t.currentRound > 5 ? '<span style="color:#22c55e;font-weight:600">FINISHED</span>' : 'Lvl ' + (t.currentRound || 1);
                    return '<div style="padding:10px;border-radius:10px;background:rgba(255,255,255,0.04);margin-bottom:8px;border:1px solid rgba(255,255,255,0.04);display:flex;justify-content:space-between;gap:10px;align-items:center">' +
                        '<div><strong>' + (idx+1) + '. ' + (t.teamName||t.teamId) + '</strong><div class="muted" style="font-size:13px">Batch ' + (t.batch ?? '—') + ' · ' + badge + '</div></div>' +
                        '<div style="text-align:right"><div style="font-weight:700;color:#60a5fa;font-size:18px">' + t.totalScore + '</div><div class="muted" style="font-size:12px">Score ' + (t.score||0) + ' − Penalty ' + (t.penalty||0) + '</div></div>' +
                    '</div>';
                }).join('');
            }

            function fetchLeaderboard(){
                var url = (typeof getApiBaseUrl === 'function' ? getApiBaseUrl() : window.API_BASE_URL || '') + '/api/leaderboard?event=escape';
                return fetch(url, { cache: 'no-store' })
                    .then(function(res){ return res.json(); })
                    .then(function(data){ renderRankings(Array.isArray(data) ? data : []); })
                    .catch(function(err){ console.error('Leaderboard load failed', err); });
            }

            function poll(){
                API.getTeam(teamId)
                .then(function(team){
                    var statusEl = document.getElementById('team-status');
                    if (team.eliminated){
                        statusEl.innerHTML = '<strong style="color: #ef4444">You have been eliminated.</strong>';
                        setTimeout(function(){ window.location.href = '../result/eliminated.html'; }, 1500);
                        return;
                    }
                    if (team.winner || Number(team.currentLevel || 1) >= 5 && team.level5_submitted){
                        statusEl.innerHTML = '<strong style="color: #2563eb">Congratulations! Winner announcement is ready.</strong>';
                        setTimeout(function(){ window.location.href = '../result/winner.html'; }, 1200);
                        return;
                    }

                    if (Number(team.currentLevel || 1) > currentLevel){
                        var nextLevel = Number(team.currentLevel || 1);
                        // Level 5 is the final level - no level 6 exists
                        if (nextLevel > 5) {
                            statusEl.innerHTML = '<strong style="color: #2563eb">All levels completed! Waiting for final results...</strong>';
                            return;
                        }
                        statusEl.innerHTML = '<strong style="color: #2563eb">You have been advanced to Level ' + nextLevel + '.</strong>';
                        setTimeout(function(){ goToNextLevel(nextLevel); }, 1200);
                        return;
                    }
                    statusEl.innerHTML = 'Waiting for admin to finalize rankings...';
                }).catch(function(err){ console.error(err); });
            }

            // Fetch full rankings and refresh every 5s.
            fetchLeaderboard();
            setInterval(fetchLeaderboard, 5000);

            // Then poll only current team status every 3 seconds.
            poll();
            var iv = setInterval(poll, 3000);
        })();
    </script>
</body>
</html>
